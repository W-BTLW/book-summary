# 챕터4. 외부 연동이 문제일 때 살펴봐야 할 것들

## 타임아웃

연동서비스에 대한 타임 아웃을 설정하지 않으면, 연동 서비스의 응답이 느릴 때 까지 처리량이 급격히 떨어진다.

### 2가지 타임아웃 방법

- **연결 타임아웃**: 네트워크 연결 시 대기 시간을 제한
- **읽기 타임아웃**: 응답을 받기까지 대기 시간을 제한

## 재시도

연동 API가 재시도 해도 되는 조건인지 확인

- 단순 조회 기능
- 연결 타임아웃 (읽기 타임아웃은 성공도 고려하여야 함)
- 멱등성을 가진 변경

### 멱등성이란?

연산을 여러 번 적용해도 결과가 달라지지 않는 성질

재시도해도 되는 조건이라면 재시도 폭풍 (retry storm) 안티패턴에 빠지지 않도록 연동 서비스의 성능을 고려하여 재시도 횟수, 간격을 결정해야 한다.

## 동시 요청 제한

B서비스가 동시 처리 개수가 100개일 때 A서비스가 동시 요청을 100개까지만 제한하면 B서비스는 성능 저하 없음

이를 위해 벌크헤드 패턴을 활용하여 동시 요청 제한

### 벌크헤드 패턴

각 구성 요소를 격리함으로써 한 구성 요소의 장애가 다른 구성 요소에 영향을 주지 않도록 하는 설계 패턴

## 서킷 브레이커

B 서비스가 정상 상태가 아닐 때 A서비스에서 요청을 보내지 않고 바로 에러를 응답

누전 차단기와 비슷하게 동작하며 닫힘, 열림, 반 열림 3가지 상태를 갖는다

실패를 빠르게 감지하고, 문제가 있는 기능을 실행하지 않고도 중단시키는 빠른 실패 방식

### 서킷 브레이커 상태 흐름

> 닫힘 상태로 시작, 닫힘 상태일 때는 모든 요청을 연동 서비스에 전달
> 오류가 발생하면, 지정한 임계치를 초과했는지 확인
> 실패 건수가 임계치를 초과하면 서킷브레이커는 열림 상태가 된다.

#### 임계치 예시

- 시간 기준: 10초 동안 오류비율 50% 초과
- 개수 기준: 100개 요청 중 오류 비율이 50% 초과

> 지정된 시간동안 열림 상태가 되면 연동요청 x, 바로 에러 응답 리턴
> 반 열림 상태가 되면 일부 요청에 한해 연동을 시도
> 연동에 성공하면 닫힘 상태로 복귀, 반대로 연동 실패 시 다시 열림 상태로 전환

## 외부연동과 DB연동

- 외부 연동에 실패했을 때 트랜잭션을 롤백
- 외부 연동은 성공했지만 DB연동에 실패해 트랜잭션을 롤백

## HTTP 커넥션 풀

- HTTP 커넥션 풀의 크기
- 풀에서 HTTP 커넥션을 가져올 때까지 대기하는 시간
- HTTP 커넥션을 유지할 시간 (Keep Alive)

## 연동 서비스 이중화 고려
